# fpy_datareader/gakushuuhi.py
"""
文部科学省 子供の学習費調査
https://www.mext.go.jp/b_menu/toukei/chousa03/gakushuuhi/1268091.htm

e-Stat
子供の学習費調査
令和５年度
2 学年（年齢）別，所在市町村の人口規模（学科）別の学習費
https://www.e-stat.go.jp/stat-search/files?page=1&layout=datalist&toukei=00400201&tstat=000001012023&cycle=0&tclass1=000001224200&tclass2=000001224201&tclass3=000001224327&tclass4val=0
"""

import re
from io import StringIO
from typing import Dict, Optional, Tuple

import openpyxl  # pandasでのExcelファイルの読み込みに必要
import numpy as np
import pandas as pd

# URL configuration using f-string for efficiency
BASE_URL = "https://www.e-stat.go.jp/stat-search/file-download"

STAT_IDS = {
    'kindergarten': '000040233660',
    'elementary': '000040233661',
    'middle': '000040233662',
    'high': '000040233663'
}

URLS = {
    level: f"{BASE_URL}?statInfId={stat_id}&fileKind=0"
    for level, stat_id in STAT_IDS.items()
}

SKIPROWS = {
    'kindergarten': 10,
    'elementary': 10,
    'middle': 10,
    'high': 9  # Different from others
}

AGE_OR_GRADE = {
    'kindergarten': '年齢別',
    'elementary': '学年別',
    'middle': '学年別',
    'high': '学年別'
}

NA_VALUES = ["…", "－"]

TIDY_COLUMNS = ["学習費区分", "学校", "学年", "学習費"]

class AgeOffsets:
    """Age offset constants for different education levels."""
    KINDERGARTEN = 2
    ELEMENTARY = 5
    MIDDLE = 11
    HIGH = 14

LEVEL_MAPPING_CSV  = """level1,level2,level3,level4
学習費総額,学校教育費,学校教育費,入学金・入園料
学習費総額,学校教育費,学校教育費,入学時に納付した施設整備費等
学習費総額,学校教育費,学校教育費,入学検定料
学習費総額,学校教育費,学校教育費,授業料
学習費総額,学校教育費,学校教育費,施設整備費等
学習費総額,学校教育費,学校教育費,修学旅行費
学習費総額,学校教育費,学校教育費,校外学習費
学習費総額,学校教育費,学校教育費,学級・児童会・生徒会費
学習費総額,学校教育費,学校教育費,その他の学校納付金
学習費総額,学校教育費,学校教育費,PTA会費
学習費総額,学校教育費,学校教育費,後援会費
学習費総額,学校教育費,学校教育費,寄附金
学習費総額,学校教育費,学校教育費,教科書費・教科書以外の図書費
学習費総額,学校教育費,学校教育費,学用品・実験実習材料費
学習費総額,学校教育費,学校教育費,教科外活動費
学習費総額,学校教育費,学校教育費,通学費
学習費総額,学校教育費,学校教育費,制服
学習費総額,学校教育費,学校教育費,通学用品費
学習費総額,学校教育費,学校教育費,その他
学習費総額,学校給食費,学校給食費,学校給食費
学習費総額,学校外活動費,補助学習費,家庭内学習費
学習費総額,学校外活動費,補助学習費,通信教育・家庭教師費
学習費総額,学校外活動費,補助学習費,学習塾費
学習費総額,学校外活動費,補助学習費,その他
学習費総額,学校外活動費,その他の学校外活動費,体験活動・地域活動
学習費総額,学校外活動費,その他の学校外活動費,芸術文化活動
学習費総額,学校外活動費,その他の学校外活動費,スポーツ・レクリエーション活動
学習費総額,学校外活動費,その他の学校外活動費,国際交流体験活動
学習費総額,学校外活動費,その他の学校外活動費,教養・その他"""

def load_raw_mapping():
    """
    Load the raw education cost category mapping without any modifications.
    
    Returns
    -------
    pd.DataFrame
        Raw mapping table with original "その他" labels.
        Contains columns: level1, level2, level3, level4 representing
        the hierarchical structure of education cost categories.

,level1,level2,level3,level4
0,学習費総額,学校教育費,学校教育費,入学金・入園料
1,学習費総額,学校教育費,学校教育費,入学時に納付した施設整備費等
2,学習費総額,学校教育費,学校教育費,入学検定料
3,学習費総額,学校教育費,学校教育費,授業料
4,学習費総額,学校教育費,学校教育費,施設整備費等
5,学習費総額,学校教育費,学校教育費,修学旅行費
6,学習費総額,学校教育費,学校教育費,校外学習費
7,学習費総額,学校教育費,学校教育費,学級・児童会・生徒会費
8,学習費総額,学校教育費,学校教育費,その他の学校納付金
9,学習費総額,学校教育費,学校教育費,PTA会費
10,学習費総額,学校教育費,学校教育費,後援会費
11,学習費総額,学校教育費,学校教育費,寄附金
12,学習費総額,学校教育費,学校教育費,教科書費・教科書以外の図書費
13,学習費総額,学校教育費,学校教育費,学用品・実験実習材料費
14,学習費総額,学校教育費,学校教育費,教科外活動費
15,学習費総額,学校教育費,学校教育費,通学費
16,学習費総額,学校教育費,学校教育費,制服
17,学習費総額,学校教育費,学校教育費,通学用品費
18,学習費総額,学校教育費,学校教育費,その他
19,学習費総額,学校給食費,学校給食費,学校給食費
20,学習費総額,学校外活動費,補助学習費,家庭内学習費
21,学習費総額,学校外活動費,補助学習費,通信教育・家庭教師費
22,学習費総額,学校外活動費,補助学習費,学習塾費
23,学習費総額,学校外活動費,補助学習費,その他
24,学習費総額,学校外活動費,その他の学校外活動費,体験活動・地域活動
25,学習費総額,学校外活動費,その他の学校外活動費,芸術文化活動
26,学習費総額,学校外活動費,その他の学校外活動費,スポーツ・レクリエーション活動
27,学習費総額,学校外活動費,その他の学校外活動費,国際交流体験活動
28,学習費総額,学校外活動費,その他の学校外活動費,教養・その他
    """
    try:
        mapping = pd.read_csv(StringIO(LEVEL_MAPPING_CSV))
        print("Raw mapping table loaded successfully")
        return mapping
        
    except Exception as e:
        print(f"Failed to load raw mapping table: {e}")
        raise
raw_mapping = load_raw_mapping()

def create_label_mapping(mapping_df):
    """
    Create a mapping dictionary for updating "その他" labels based on context.
    
    Parameters
    ----------
    mapping_df : pd.DataFrame
        The mapping DataFrame containing education cost categories.
        
    Returns
    -------
    Dict[int, Dict[str, str]]
        Dictionary mapping index positions to context information.
        Contains 'level3' and 'level4' for each position.

{0: {'level3': '学校教育費', 'level4': '入学金・入園料'},
 1: {'level3': '学校教育費', 'level4': '入学時に納付した施設整備費等'},
 2: {'level3': '学校教育費', 'level4': '入学検定料'},
 3: {'level3': '学校教育費', 'level4': '授業料'},
 4: {'level3': '学校教育費', 'level4': '施設整備費等'},
 5: {'level3': '学校教育費', 'level4': '修学旅行費'},
 6: {'level3': '学校教育費', 'level4': '校外学習費'},
 7: {'level3': '学校教育費', 'level4': '学級・児童会・生徒会費'},
 8: {'level3': '学校教育費', 'level4': 'その他の学校納付金'},
 9: {'level3': '学校教育費', 'level4': 'PTA会費'},
 10: {'level3': '学校教育費', 'level4': '後援会費'},
 11: {'level3': '学校教育費', 'level4': '寄附金'},
 12: {'level3': '学校教育費', 'level4': '教科書費・教科書以外の図書費'},
 13: {'level3': '学校教育費', 'level4': '学用品・実験実習材料費'},
 14: {'level3': '学校教育費', 'level4': '教科外活動費'},
 15: {'level3': '学校教育費', 'level4': '通学費'},
 16: {'level3': '学校教育費', 'level4': '制服'},
 17: {'level3': '学校教育費', 'level4': '通学用品費'},
 18: {'level3': '学校教育費', 'level4': 'その他'},
 19: {'level3': '学校給食費', 'level4': '学校給食費'},
 20: {'level3': '補助学習費', 'level4': '家庭内学習費'},
 21: {'level3': '補助学習費', 'level4': '通信教育・家庭教師費'},
 22: {'level3': '補助学習費', 'level4': '学習塾費'},
 23: {'level3': '補助学習費', 'level4': 'その他'},
 24: {'level3': 'その他の学校外活動費', 'level4': '体験活動・地域活動'},
 25: {'level3': 'その他の学校外活動費', 'level4': '芸術文化活動'},
 26: {'level3': 'その他の学校外活動費', 'level4': 'スポーツ・レクリエーション活動'},
 27: {'level3': 'その他の学校外活動費', 'level4': '国際交流体験活動'},
 28: {'level3': 'その他の学校外活動費', 'level4': '教養・その他'}}
    """
    return {
        i: {'level3': row['level3'], 'level4': row['level4']}
        for i, row in mapping_df.iterrows()
    }
label_mapping = create_label_mapping(raw_mapping)


def process_mapping(mapping):
    """
    Process the raw mapping by disambiguating "その他" labels.
    
    Parameters
    ----------
    mapping : pd.DataFrame
        Raw mapping table with original "その他" labels.
        
    Returns
    -------
    pd.DataFrame
        Processed mapping table with disambiguated "その他" labels.
        "その他" labels are updated to include parent category context.

,level1,level2,level3,level4
0,学習費総額,学校教育費,学校教育費,入学金・入園料
1,学習費総額,学校教育費,学校教育費,入学時に納付した施設整備費等
2,学習費総額,学校教育費,学校教育費,入学検定料
3,学習費総額,学校教育費,学校教育費,授業料
4,学習費総額,学校教育費,学校教育費,施設整備費等
5,学習費総額,学校教育費,学校教育費,修学旅行費
6,学習費総額,学校教育費,学校教育費,校外学習費
7,学習費総額,学校教育費,学校教育費,学級・児童会・生徒会費
8,学習費総額,学校教育費,学校教育費,その他の学校納付金
9,学習費総額,学校教育費,学校教育費,PTA会費
10,学習費総額,学校教育費,学校教育費,後援会費
11,学習費総額,学校教育費,学校教育費,寄附金
12,学習費総額,学校教育費,学校教育費,教科書費・教科書以外の図書費
13,学習費総額,学校教育費,学校教育費,学用品・実験実習材料費
14,学習費総額,学校教育費,学校教育費,教科外活動費
15,学習費総額,学校教育費,学校教育費,通学費
16,学習費総額,学校教育費,学校教育費,制服
17,学習費総額,学校教育費,学校教育費,通学用品費
18,学習費総額,学校教育費,学校教育費,その他学校教育費
19,学習費総額,学校給食費,学校給食費,学校給食費
20,学習費総額,学校外活動費,補助学習費,家庭内学習費
21,学習費総額,学校外活動費,補助学習費,通信教育・家庭教師費
22,学習費総額,学校外活動費,補助学習費,学習塾費
23,学習費総額,学校外活動費,補助学習費,その他補助学習費
24,学習費総額,学校外活動費,その他の学校外活動費,体験活動・地域活動
25,学習費総額,学校外活動費,その他の学校外活動費,芸術文化活動
26,学習費総額,学校外活動費,その他の学校外活動費,スポーツ・レクリエーション活動
27,学習費総額,学校外活動費,その他の学校外活動費,国際交流体験活動
28,学習費総額,学校外活動費,その他の学校外活動費,教養・その他
    """
    try:
        mapping_processed = mapping.copy()
        
        # Disambiguate "その他" labels by adding parent category context
        mask1 = (mapping_processed.level3 == "学校教育費") & (mapping_processed.level4 == "その他")
        mask2 = (mapping_processed.level3 == "補助学習費") & (mapping_processed.level4 == "その他")
        
        mapping_processed.loc[mask1, "level4"] = "その他学校教育費"
        mapping_processed.loc[mask2, "level4"] = "その他補助学習費"
        
        print("Mapping table processed successfully")
        return mapping_processed
        
    except Exception as e:
        print(f"Failed to process mapping table: {e}")
        raise
processed_mapping = process_mapping(raw_mapping)

def load_education_data():
    """
    Load education cost data for all education levels.
    
    Returns
    -------
    Dict[str, pd.DataFrame]
        Dictionary containing DataFrames for each education level.
        Keys are 'kindergarten', 'elementary', 'middle', 'high'.
        Each DataFrame contains education cost data with multi-level headers.

        
education_data['elementary']

区分,公立小学校,公立小学校,公立小学校,公立小学校,公立小学校,公立小学校,私立小学校,私立小学校,私立小学校,私立小学校,私立小学校,私立小学校
,学年別,学年別,学年別,学年別,学年別,学年別,学年別,学年別,学年別,学年別,学年別,学年別
,第1学年,第2学年,第3学年,第4学年,第5学年,第6学年,第1学年,第2学年,第3学年,第4学年,第5学年,第6学年
学習費総額,398268.0,268137.0,295461.0,305403.0,354437.0,395672.0,2202541.0,1628139.0,1772477.0,1682848.0,1782459.0,1905930.0
学校教育費,159953.0,53407.0,53125.0,60511.0,72312.0,94310.0,1479093.0,941620.0,1080293.0,928601.0,920953.0,974778.0
入学金・入園料,2140.0,,,,,,243997.0,,,,,
入学時に納付した施設整備費等,4175.0,,,,,,114400.0,,,,,
入学検定料,253.0,,,,,,33307.0,,,,,
授業料,,,,,,,510406.0,585325.0,535844.0,534086.0,542382.0,504395.0
施設整備費等,,,,,,,97770.0,110350.0,104443.0,101450.0,122745.0,88953.0
修学旅行費,,,,,31.0,21986.0,,,,502.0,2081.0,71924.0
校外学習費,1408.0,872.0,1905.0,1759.0,5996.0,1960.0,11493.0,15512.0,26869.0,31830.0,37888.0,27203.0
学級・児童会・生徒会費,2560.0,2171.0,1714.0,2468.0,3311.0,2787.0,6481.0,7236.0,12497.0,7002.0,8053.0,7944.0
その他の学校納付金,2827.0,1870.0,3741.0,2678.0,4012.0,2478.0,17554.0,18053.0,75548.0,19361.0,13949.0,15863.0
PTA会費,2745.0,2303.0,2029.0,3697.0,2701.0,2677.0,7732.0,7388.0,7749.0,7748.0,7473.0,7979.0
後援会費,85.0,48.0,15.0,39.0,19.0,46.0,5943.0,3514.0,3658.0,5346.0,5481.0,7063.0
寄附金,62.0,1730.0,225.0,248.0,305.0,30.0,84783.0,24517.0,119923.0,36306.0,16479.0,36577.0
教科書費・教科書以外の図書費,5672.0,7038.0,5047.0,4975.0,6594.0,5841.0,23668.0,25693.0,22607.0,25068.0,19707.0,52765.0
学用品・実験実習材料費,46073.0,20113.0,24208.0,24274.0,26829.0,19339.0,68030.0,40064.0,43769.0,35257.0,36545.0,30146.0
教科外活動費,2109.0,1032.0,1033.0,3618.0,5434.0,5430.0,12730.0,10806.0,10496.0,15957.0,14904.0,16619.0
通学費,1923.0,1330.0,504.0,1012.0,763.0,3484.0,46301.0,47562.0,52703.0,48253.0,41713.0,42862.0
制服,2555.0,425.0,533.0,905.0,448.0,7007.0,102235.0,17032.0,36038.0,35968.0,30130.0,28459.0
通学用品費,73472.0,10380.0,7714.0,9740.0,9363.0,9732.0,73210.0,15430.0,17396.0,14458.0,13283.0,13187.0
その他,11894.0,4095.0,4457.0,5098.0,6506.0,11513.0,19053.0,13138.0,10753.0,10009.0,8140.0,22839.0
学校給食費,39313.0,40508.0,39184.0,35662.0,39105.0,36789.0,57217.0,55371.0,53203.0,55981.0,49181.0,50579.0
学校外活動費,199002.0,174222.0,203152.0,209230.0,243020.0,264573.0,666231.0,631148.0,638981.0,698266.0,812325.0,880573.0
補助学習費,76973.0,57854.0,79653.0,80355.0,118447.0,140878.0,282120.0,247079.0,285300.0,356086.0,500010.0,588650.0
家庭内学習費,31072.0,9901.0,11078.0,9709.0,12984.0,10779.0,85169.0,42348.0,38339.0,36461.0,29934.0,35092.0
通信教育・家庭教師費,20302.0,18671.0,26902.0,15700.0,24475.0,19897.0,37398.0,47548.0,45625.0,46608.0,78184.0,99601.0
学習塾費,24839.0,27898.0,40776.0,53250.0,79469.0,106785.0,154320.0,152996.0,194411.0,265503.0,384938.0,438259.0
その他,760.0,1384.0,897.0,1696.0,1519.0,3417.0,5233.0,4187.0,6925.0,7514.0,6954.0,15698.0
その他の学校外活動費,122029.0,116368.0,123499.0,128875.0,124573.0,123695.0,384111.0,384069.0,353681.0,342180.0,312315.0,291923.0
体験活動・地域活動,7567.0,11309.0,3645.0,4507.0,5472.0,3803.0,43098.0,26181.0,30943.0,26917.0,21303.0,15165.0
芸術文化活動,35850.0,28663.0,29410.0,23841.0,25072.0,32801.0,98898.0,109974.0,92300.0,83809.0,97089.0,93569.0
スポーツ・レクリエーション活動,45644.0,50394.0,64966.0,67195.0,54732.0,53139.0,109406.0,114255.0,113196.0,101123.0,84413.0,80715.0
国際交流体験活動,404.0,256.0,107.0,952.0,809.0,1858.0,15410.0,8904.0,17250.0,31269.0,37337.0,40021.0
教養・その他,32564.0,25746.0,25371.0,32380.0,38488.0,32094.0,117299.0,124755.0,99992.0,99062.0,72173.0,62453.0
    """
    data = {}
    
    for level in ['kindergarten', 'elementary', 'middle', 'high']:
        try:
            print(f"Loading {level} data...")
            
            df = pd.read_excel(
                URLS[level],
                skiprows=SKIPROWS[level],
                header=[0, 1, 2],
                index_col=0,
                na_values=NA_VALUES
            )
            
            # Filter columns based on education level
            header_col = AGE_OR_GRADE[level]
            df = df.loc[:, pd.IndexSlice[:, header_col, :]]
            
            data[level] = df
            print(f"Successfully loaded {level} data")
            
        except Exception as e:
            print(f"Failed to load {level} data: {e}")
            raise
    
    return data

education_data = load_education_data()

def update_index_labels(df, mapping_dict):
    """
    Original implementation using context tracking.
    
    Parameters
    ----------
    df : pd.DataFrame
        DataFrame whose index labels need to be updated.
    mapping_dict : Dict[int, Dict[str, str]]
        Dictionary mapping (not used in this implementation).
        
    Returns
    -------
    pd.DataFrame
        DataFrame with updated index labels using context tracking method.

education_data_updated = {}
for level in education_data:
    education_data_updated[level] = update_index_labels(
        education_data[level], 
        label_mapping
    )
education_data_updated['elementary']

区分,公立小学校,公立小学校,公立小学校,公立小学校,公立小学校,公立小学校,私立小学校,私立小学校,私立小学校,私立小学校,私立小学校,私立小学校
,学年別,学年別,学年別,学年別,学年別,学年別,学年別,学年別,学年別,学年別,学年別,学年別
,第1学年,第2学年,第3学年,第4学年,第5学年,第6学年,第1学年,第2学年,第3学年,第4学年,第5学年,第6学年
学習費総額,398268.0,268137.0,295461.0,305403.0,354437.0,395672.0,2202541.0,1628139.0,1772477.0,1682848.0,1782459.0,1905930.0
学校教育費,159953.0,53407.0,53125.0,60511.0,72312.0,94310.0,1479093.0,941620.0,1080293.0,928601.0,920953.0,974778.0
入学金・入園料,2140.0,,,,,,243997.0,,,,,
入学時に納付した施設整備費等,4175.0,,,,,,114400.0,,,,,
入学検定料,253.0,,,,,,33307.0,,,,,
授業料,,,,,,,510406.0,585325.0,535844.0,534086.0,542382.0,504395.0
施設整備費等,,,,,,,97770.0,110350.0,104443.0,101450.0,122745.0,88953.0
修学旅行費,,,,,31.0,21986.0,,,,502.0,2081.0,71924.0
校外学習費,1408.0,872.0,1905.0,1759.0,5996.0,1960.0,11493.0,15512.0,26869.0,31830.0,37888.0,27203.0
学級・児童会・生徒会費,2560.0,2171.0,1714.0,2468.0,3311.0,2787.0,6481.0,7236.0,12497.0,7002.0,8053.0,7944.0
その他の学校納付金,2827.0,1870.0,3741.0,2678.0,4012.0,2478.0,17554.0,18053.0,75548.0,19361.0,13949.0,15863.0
PTA会費,2745.0,2303.0,2029.0,3697.0,2701.0,2677.0,7732.0,7388.0,7749.0,7748.0,7473.0,7979.0
後援会費,85.0,48.0,15.0,39.0,19.0,46.0,5943.0,3514.0,3658.0,5346.0,5481.0,7063.0
寄附金,62.0,1730.0,225.0,248.0,305.0,30.0,84783.0,24517.0,119923.0,36306.0,16479.0,36577.0
教科書費・教科書以外の図書費,5672.0,7038.0,5047.0,4975.0,6594.0,5841.0,23668.0,25693.0,22607.0,25068.0,19707.0,52765.0
学用品・実験実習材料費,46073.0,20113.0,24208.0,24274.0,26829.0,19339.0,68030.0,40064.0,43769.0,35257.0,36545.0,30146.0
教科外活動費,2109.0,1032.0,1033.0,3618.0,5434.0,5430.0,12730.0,10806.0,10496.0,15957.0,14904.0,16619.0
通学費,1923.0,1330.0,504.0,1012.0,763.0,3484.0,46301.0,47562.0,52703.0,48253.0,41713.0,42862.0
制服,2555.0,425.0,533.0,905.0,448.0,7007.0,102235.0,17032.0,36038.0,35968.0,30130.0,28459.0
通学用品費,73472.0,10380.0,7714.0,9740.0,9363.0,9732.0,73210.0,15430.0,17396.0,14458.0,13283.0,13187.0
その他学校教育費,11894.0,4095.0,4457.0,5098.0,6506.0,11513.0,19053.0,13138.0,10753.0,10009.0,8140.0,22839.0
学校給食費,39313.0,40508.0,39184.0,35662.0,39105.0,36789.0,57217.0,55371.0,53203.0,55981.0,49181.0,50579.0
学校外活動費,199002.0,174222.0,203152.0,209230.0,243020.0,264573.0,666231.0,631148.0,638981.0,698266.0,812325.0,880573.0
補助学習費,76973.0,57854.0,79653.0,80355.0,118447.0,140878.0,282120.0,247079.0,285300.0,356086.0,500010.0,588650.0
家庭内学習費,31072.0,9901.0,11078.0,9709.0,12984.0,10779.0,85169.0,42348.0,38339.0,36461.0,29934.0,35092.0
通信教育・家庭教師費,20302.0,18671.0,26902.0,15700.0,24475.0,19897.0,37398.0,47548.0,45625.0,46608.0,78184.0,99601.0
学習塾費,24839.0,27898.0,40776.0,53250.0,79469.0,106785.0,154320.0,152996.0,194411.0,265503.0,384938.0,438259.0
その他補助学習費,760.0,1384.0,897.0,1696.0,1519.0,3417.0,5233.0,4187.0,6925.0,7514.0,6954.0,15698.0
その他の学校外活動費,122029.0,116368.0,123499.0,128875.0,124573.0,123695.0,384111.0,384069.0,353681.0,342180.0,312315.0,291923.0
体験活動・地域活動,7567.0,11309.0,3645.0,4507.0,5472.0,3803.0,43098.0,26181.0,30943.0,26917.0,21303.0,15165.0
芸術文化活動,35850.0,28663.0,29410.0,23841.0,25072.0,32801.0,98898.0,109974.0,92300.0,83809.0,97089.0,93569.0
スポーツ・レクリエーション活動,45644.0,50394.0,64966.0,67195.0,54732.0,53139.0,109406.0,114255.0,113196.0,101123.0,84413.0,80715.0
国際交流体験活動,404.0,256.0,107.0,952.0,809.0,1858.0,15410.0,8904.0,17250.0,31269.0,37337.0,40021.0
教養・その他,32564.0,25746.0,25371.0,32380.0,38488.0,32094.0,117299.0,124755.0,99992.0,99062.0,72173.0,62453.0

    """
    df_copy = df.copy()
    
    # Create new index by replacing labels that exist in mapping_dict
    new_index = []
    context_tracker = None  # Track current context for disambiguating "その他"
    
    for label in df_copy.index:
        # Track context for "その他" disambiguation
        if label in ["学校教育費", "補助学習費"]:
            context_tracker = label
        
        # Replace "その他" based on current context
        if label == "その他" and context_tracker:
            new_index.append(f"{label}{context_tracker}")
        else:
            new_index.append(label)
    
    df_copy.index = new_index
    return df_copy
education_data_updated = {}
for level in education_data:
    education_data_updated[level] = update_index_labels(
        education_data[level], 
        label_mapping
    )

def convert_to_tidy(data):
    """
    Convert education data to tidy format.
    
    Parameters
    ----------
    data : Dict[str, pd.DataFrame]
        Dictionary of DataFrames for each education level.
        
    Returns
    -------
    pd.DataFrame
        Combined DataFrame in tidy format with columns:
        ['学習費区分', '学校', '学年', '学習費'].

df_tidy.head(20)
,学習費区分,学校,学年,学習費
0,学習費総額,公立幼稚園,3歳,149591.0
1,学習費総額,公立幼稚園,4歳,166969.0
2,学習費総額,公立幼稚園,5歳,215617.0
3,学習費総額,私立幼稚園,3歳,335350.0
4,学習費総額,私立幼稚園,4歳,323783.0
5,学習費総額,私立幼稚園,5歳,378954.0
6,学校教育費,公立幼稚園,3歳,79011.0
7,学校教育費,公立幼稚園,4歳,54478.0
8,学校教育費,公立幼稚園,5歳,76088.0
9,学校教育費,私立幼稚園,3歳,203133.0
10,学校教育費,私立幼稚園,4歳,120290.0
11,学校教育費,私立幼稚園,5歳,143980.0
12,入学金・入園料,公立幼稚園,3歳,1025.0
13,入学金・入園料,公立幼稚園,4歳,322.0
14,入学金・入園料,公立幼稚園,5歳,
15,入学金・入園料,私立幼稚園,3歳,41960.0
16,入学金・入園料,私立幼稚園,4歳,
17,入学金・入園料,私立幼稚園,5歳,
18,入学時に納付した施設整備費等,公立幼稚園,3歳,727.0
19,入学時に納付した施設整備費等,公立幼稚園,4歳,59.0
20,入学時に納付した施設整備費等,公立幼稚園,5歳,

    """
    tidy_dfs = []
    
    for level, df in data.items():
        try:
            # Stack to create tidy format
            tidy_df = (df.stack([0, 2], future_stack=True)
                      .reset_index()
                      .set_axis(TIDY_COLUMNS, axis=1))
            
            tidy_dfs.append(tidy_df)
            print(f"Converted {level} data to tidy format")
            
        except Exception as e:
            print(f"Failed to convert {level} data to tidy format: {e}")
            raise
    
    return pd.concat(tidy_dfs, ignore_index=True)

df_tidy = convert_to_tidy(education_data_updated)


def split_school_info(df):
    """
    Split school information into public/private and school type.
    
    Parameters
    ----------
    df : pd.DataFrame
        DataFrame with '学校' column containing combined school information.
        
    Returns
    -------
    pd.DataFrame
        DataFrame with separated school information:
        - '公立・私立区分': Public or private classification
        - '学校': School type without public/private prefix

,学習費区分,学年,学習費,公立・私立区分,学校
0,学習費総額,3歳,149591.0,公立,幼稚園
1,学習費総額,4歳,166969.0,公立,幼稚園
2,学習費総額,5歳,215617.0,公立,幼稚園
3,学習費総額,3歳,335350.0,私立,幼稚園
4,学習費総額,4歳,323783.0,私立,幼稚園
5,学習費総額,5歳,378954.0,私立,幼稚園
6,学校教育費,3歳,79011.0,公立,幼稚園
7,学校教育費,4歳,54478.0,公立,幼稚園
8,学校教育費,5歳,76088.0,公立,幼稚園
9,学校教育費,3歳,203133.0,私立,幼稚園
10,学校教育費,4歳,120290.0,私立,幼稚園
11,学校教育費,5歳,143980.0,私立,幼稚園
12,入学金・入園料,3歳,1025.0,公立,幼稚園
13,入学金・入園料,4歳,322.0,公立,幼稚園
14,入学金・入園料,5歳,,公立,幼稚園
15,入学金・入園料,3歳,41960.0,私立,幼稚園
16,入学金・入園料,4歳,,私立,幼稚園
17,入学金・入園料,5歳,,私立,幼稚園
18,入学時に納付した施設整備費等,3歳,727.0,公立,幼稚園
19,入学時に納付した施設整備費等,4歳,59.0,公立,幼稚園
20,入学時に納付した施設整備費等,5歳,,公立,幼稚園
    """
    df_copy = df.copy()
    
    # Extract public/private and school type
    split_df = df_copy["学校"].str.extract(r'^(公立|私立)(.+)$')
    split_df.columns = ["公立・私立区分", "学校"]
    
    # Replace original school column with split information
    df_result = df_copy.drop(columns="学校").join(split_df)
    
    print("School information split successfully")
    return df_result
df_split = split_school_info(df_tidy)


def extract_grade_info(grade_str):
    """
    Extract age and grade information from grade string.
    
    Parameters
    ----------
    grade_str : str
        String containing grade information (e.g., "3歳", "第1学年").
        
    Returns
    -------
    Tuple[Optional[int], Optional[int]]
        Tuple containing (age, grade). Returns (age, None) for kindergarten
        age strings, (None, grade) for school grade strings, or (None, None)
        if no pattern matches.
    """
    if "歳" in grade_str:
        match = re.search(r'(\d+)歳', grade_str)
        return int(match.group(1)) if match else None, None
    elif "学年" in grade_str:
        match = re.search(r'第(\d+)学年', grade_str)
        return None, int(match.group(1)) if match else None
    return None, None

def calculate_age_vectorized(df):
    """
    Calculate age using vectorized operations.
    
    Parameters
    ----------
    df : pd.DataFrame
        DataFrame with '学校' and '学年' columns.
        
    Returns
    -------
    pd.Series
        Series containing calculated ages based on school type and grade.
        Uses predefined age offsets for different education levels.
    """
    conditions = [
        df["学校"].str.contains("幼稚園"),
        df["学校"].str.contains("小学校"),
        df["学校"].str.contains("中学校"),
        df["学校"].str.contains("高等学校")
    ]
    
    choices = [
        df["学年"] + AgeOffsets.KINDERGARTEN,
        df["学年"] + AgeOffsets.ELEMENTARY,
        df["学年"] + AgeOffsets.MIDDLE,
        df["学年"] + AgeOffsets.HIGH
    ]
    
    return np.select(conditions, choices, default=np.nan)
    
def process_grade_and_age(df):
    """
    Process grade and age information.
    
    Parameters
    ----------
    df : pd.DataFrame
        DataFrame with original grade strings in '学年' column.
        
    Returns
    -------
    pd.DataFrame
        DataFrame with processed grade and age columns:
        - '学年': Standardized 1-based grade numbers
        - '年齢': Calculated ages based on school type and grade

,学習費区分,学年,学習費,公立・私立区分,学校,年齢
0,学習費総額,1,149591.0,公立,幼稚園,3
1,学習費総額,2,166969.0,公立,幼稚園,4
2,学習費総額,3,215617.0,公立,幼稚園,5
3,学習費総額,1,335350.0,私立,幼稚園,3
4,学習費総額,2,323783.0,私立,幼稚園,4
5,学習費総額,3,378954.0,私立,幼稚園,5
6,学校教育費,1,79011.0,公立,幼稚園,3
7,学校教育費,2,54478.0,公立,幼稚園,4
8,学校教育費,3,76088.0,公立,幼稚園,5
9,学校教育費,1,203133.0,私立,幼稚園,3
10,学校教育費,2,120290.0,私立,幼稚園,4
11,学校教育費,3,143980.0,私立,幼稚園,5
12,入学金・入園料,1,1025.0,公立,幼稚園,3
13,入学金・入園料,2,322.0,公立,幼稚園,4
14,入学金・入園料,3,,公立,幼稚園,5
15,入学金・入園料,1,41960.0,私立,幼稚園,3
16,入学金・入園料,2,,私立,幼稚園,4
17,入学金・入園料,3,,私立,幼稚園,5
18,入学時に納付した施設整備費等,1,727.0,公立,幼稚園,3
19,入学時に納付した施設整備費等,2,59.0,公立,幼稚園,4
20,入学時に納付した施設整備費等,3,,公立,幼稚園,5
    """
    df_copy = df.copy()
    
    # Store original grade string
    df_copy["orig_grade"] = df_copy["学年"]
    
    # Extract age and grade information
    grade_info = df_copy["orig_grade"].apply(extract_grade_info)
    df_copy["age_extracted"] = [info[0] for info in grade_info]
    df_copy["grade_extracted"] = [info[1] for info in grade_info]
    
    # Calculate standardized grade (1-based)
    df_copy["学年"] = np.where(
        df_copy["grade_extracted"].notna(),
        df_copy["grade_extracted"],
        df_copy["age_extracted"] - AgeOffsets.KINDERGARTEN
    ).astype(int)
    
    # Calculate age
    df_copy["年齢"] = np.where(
        df_copy["age_extracted"].notna(),
        df_copy["age_extracted"],
        calculate_age_vectorized(df_copy)
    ).astype(int)
    
    # Clean up temporary columns
    df_copy = df_copy.drop(columns=["orig_grade", "age_extracted", "grade_extracted"])
    
    print("Grade and age processing completed")
    return df_copy
    
df_processed = process_grade_and_age(df_split)  


def merge_with_mapping(df, mapping):
    """
    Merge education data with category mapping.
    
    Parameters
    ----------
    df : pd.DataFrame
        Processed education data with '学習費区分' column.
    mapping : pd.DataFrame
        Category mapping table with hierarchical levels.
        
    Returns
    -------
    pd.DataFrame
        Merged DataFrame with category hierarchy columns:
        ['学習費区分1', '学習費区分2', '学習費区分3', '学習費区分4'].
        Rows with unmapped categories are removed.

df_merged = merge_with_mapping(df_processed, processed_mapping).fillna(0)
df_final = df_merged[['公立・私立区分', '学校', '学年', '年齢', '学習費区分1', '学習費区分2', '学習費区分3', '学習費区分4', '学習費']].sort_values(['公立・私立区分', '年齢'])
df_final

,公立・私立区分,学校,学年,年齢,学習費区分1,学習費区分2,学習費区分3,学習費区分4,学習費
12,公立,幼稚園,1,3,学習費総額,学校教育費,学校教育費,入学金・入園料,1025.0
18,公立,幼稚園,1,3,学習費総額,学校教育費,学校教育費,入学時に納付した施設整備費等,727.0
24,公立,幼稚園,1,3,学習費総額,学校教育費,学校教育費,入学検定料,97.0
30,公立,幼稚園,1,3,学習費総額,学校教育費,学校教育費,授業料,4223.0
36,公立,幼稚園,1,3,学習費総額,学校教育費,学校教育費,施設整備費等,0.0
42,公立,幼稚園,1,3,学習費総額,学校教育費,学校教育費,修学旅行費,0.0
48,公立,幼稚園,1,3,学習費総額,学校教育費,学校教育費,校外学習費,1040.0
54,公立,幼稚園,1,3,学習費総額,学校教育費,学校教育費,学級・児童会・生徒会費,1798.0
60,公立,幼稚園,1,3,学習費総額,学校教育費,学校教育費,その他の学校納付金,1715.0
66,公立,幼稚園,1,3,学習費総額,学校教育費,学校教育費,PTA会費,4189.0
72,公立,幼稚園,1,3,学習費総額,学校教育費,学校教育費,後援会費,127.0
78,公立,幼稚園,1,3,学習費総額,学校教育費,学校教育費,寄附金,146.0
84,公立,幼稚園,1,3,学習費総額,学校教育費,学校教育費,教科書費・教科書以外の図書費,3134.0
90,公立,幼稚園,1,3,学習費総額,学校教育費,学校教育費,学用品・実験実習材料費,12588.0
96,公立,幼稚園,1,3,学習費総額,学校教育費,学校教育費,教科外活動費,614.0
102,公立,幼稚園,1,3,学習費総額,学校教育費,学校教育費,通学費,13857.0
108,公立,幼稚園,1,3,学習費総額,学校教育費,学校教育費,制服,6225.0
114,公立,幼稚園,1,3,学習費総額,学校教育費,学校教育費,通学用品費,11430.0
120,公立,幼稚園,1,3,学習費総額,学校教育費,学校教育費,その他学校教育費,16076.0
126,公立,幼稚園,1,3,学習費総額,学校給食費,学校給食費,学校給食費,14951.0
144,公立,幼稚園,1,3,学習費総額,学校外活動費,補助学習費,家庭内学習費,5897.0
150,公立,幼稚園,1,3,学習費総額,学校外活動費,補助学習費,通信教育・家庭教師費,6568.0
156,公立,幼稚園,1,3,学習費総額,学校外活動費,補助学習費,学習塾費,6109.0
162,公立,幼稚園,1,3,学習費総額,学校外活動費,補助学習費,その他補助学習費,347.0
174,公立,幼稚園,1,3,学習費総額,学校外活動費,その他の学校外活動費,体験活動・地域活動,2566.0
180,公立,幼稚園,1,3,学習費総額,学校外活動費,その他の学校外活動費,芸術文化活動,4331.0
186,公立,幼稚園,1,3,学習費総額,学校外活動費,その他の学校外活動費,スポーツ・レクリエーション活動,11960.0
192,公立,幼稚園,1,3,学習費総額,学校外活動費,その他の学校外活動費,国際交流体験活動,47.0
198,公立,幼稚園,1,3,学習費総額,学校外活動費,その他の学校外活動費,教養・その他,17804.0
13,公立,幼稚園,2,4,学習費総額,学校教育費,学校教育費,入学金・入園料,322.0
19,公立,幼稚園,2,4,学習費総額,学校教育費,学校教育費,入学時に納付した施設整備費等,59.0
25,公立,幼稚園,2,4,学習費総額,学校教育費,学校教育費,入学検定料,13.0
31,公立,幼稚園,2,4,学習費総額,学校教育費,学校教育費,授業料,5929.0
37,公立,幼稚園,2,4,学習費総額,学校教育費,学校教育費,施設整備費等,0.0
43,公立,幼稚園,2,4,学習費総額,学校教育費,学校教育費,修学旅行費,0.0
49,公立,幼稚園,2,4,学習費総額,学校教育費,学校教育費,校外学習費,1441.0
55,公立,幼稚園,2,4,学習費総額,学校教育費,学校教育費,学級・児童会・生徒会費,1728.0
61,公立,幼稚園,2,4,学習費総額,学校教育費,学校教育費,その他の学校納付金,1620.0
67,公立,幼稚園,2,4,学習費総額,学校教育費,学校教育費,PTA会費,4004.0
73,公立,幼稚園,2,4,学習費総額,学校教育費,学校教育費,後援会費,63.0
79,公立,幼稚園,2,4,学習費総額,学校教育費,学校教育費,寄附金,81.0
85,公立,幼稚園,2,4,学習費総額,学校教育費,学校教育費,教科書費・教科書以外の図書費,2899.0
91,公立,幼稚園,2,4,学習費総額,学校教育費,学校教育費,学用品・実験実習材料費,8869.0
97,公立,幼稚園,2,4,学習費総額,学校教育費,学校教育費,教科外活動費,448.0
103,公立,幼稚園,2,4,学習費総額,学校教育費,学校教育費,通学費,6564.0
109,公立,幼稚園,2,4,学習費総額,学校教育費,学校教育費,制服,2539.0
115,公立,幼稚園,2,4,学習費総額,学校教育費,学校教育費,通学用品費,7275.0
121,公立,幼稚園,2,4,学習費総額,学校教育費,学校教育費,その他学校教育費,10624.0
127,公立,幼稚園,2,4,学習費総額,学校給食費,学校給食費,学校給食費,14649.0
145,公立,幼稚園,2,4,学習費総額,学校外活動費,補助学習費,家庭内学習費,6948.0
151,公立,幼稚園,2,4,学習費総額,学校外活動費,補助学習費,通信教育・家庭教師費,9805.0
157,公立,幼稚園,2,4,学習費総額,学校外活動費,補助学習費,学習塾費,14313.0
163,公立,幼稚園,2,4,学習費総額,学校外活動費,補助学習費,その他補助学習費,820.0
175,公立,幼稚園,2,4,学習費総額,学校外活動費,その他の学校外活動費,体験活動・地域活動,5080.0
181,公立,幼稚園,2,4,学習費総額,学校外活動費,その他の学校外活動費,芸術文化活動,12801.0
187,公立,幼稚園,2,4,学習費総額,学校外活動費,その他の学校外活動費,スポーツ・レクリエーション活動,25161.0
193,公立,幼稚園,2,4,学習費総額,学校外活動費,その他の学校外活動費,国際交流体験活動,885.0
199,公立,幼稚園,2,4,学習費総額,学校外活動費,その他の学校外活動費,教養・その他,22029.0
14,公立,幼稚園,3,5,学習費総額,学校教育費,学校教育費,入学金・入園料,0.0
20,公立,幼稚園,3,5,学習費総額,学校教育費,学校教育費,入学時に納付した施設整備費等,0.0
26,公立,幼稚園,3,5,学習費総額,学校教育費,学校教育費,入学検定料,0.0
32,公立,幼稚園,3,5,学習費総額,学校教育費,学校教育費,授業料,5610.0
38,公立,幼稚園,3,5,学習費総額,学校教育費,学校教育費,施設整備費等,0.0
44,公立,幼稚園,3,5,学習費総額,学校教育費,学校教育費,修学旅行費,0.0
50,公立,幼稚園,3,5,学習費総額,学校教育費,学校教育費,校外学習費,1751.0
56,公立,幼稚園,3,5,学習費総額,学校教育費,学校教育費,学級・児童会・生徒会費,1891.0
62,公立,幼稚園,3,5,学習費総額,学校教育費,学校教育費,その他の学校納付金,1458.0
68,公立,幼稚園,3,5,学習費総額,学校教育費,学校教育費,PTA会費,3839.0
74,公立,幼稚園,3,5,学習費総額,学校教育費,学校教育費,後援会費,132.0
80,公立,幼稚園,3,5,学習費総額,学校教育費,学校教育費,寄附金,219.0
86,公立,幼稚園,3,5,学習費総額,学校教育費,学校教育費,教科書費・教科書以外の図書費,2873.0
92,公立,幼稚園,3,5,学習費総額,学校教育費,学校教育費,学用品・実験実習材料費,10213.0
98,公立,幼稚園,3,5,学習費総額,学校教育費,学校教育費,教科外活動費,1405.0
104,公立,幼稚園,3,5,学習費総額,学校教育費,学校教育費,通学費,6891.0
110,公立,幼稚園,3,5,学習費総額,学校教育費,学校教育費,制服,2496.0
116,公立,幼稚園,3,5,学習費総額,学校教育費,学校教育費,通学用品費,22918.0
122,公立,幼稚園,3,5,学習費総額,学校教育費,学校教育費,その他学校教育費,14392.0
128,公立,幼稚園,3,5,学習費総額,学校給食費,学校給食費,学校給食費,15829.0
146,公立,幼稚園,3,5,学習費総額,学校外活動費,補助学習費,家庭内学習費,11879.0
152,公立,幼稚園,3,5,学習費総額,学校外活動費,補助学習費,通信教育・家庭教師費,11502.0
158,公立,幼稚園,3,5,学習費総額,学校外活動費,補助学習費,学習塾費,18034.0
164,公立,幼稚園,3,5,学習費総額,学校外活動費,補助学習費,その他補助学習費,862.0
176,公立,幼稚園,3,5,学習費総額,学校外活動費,その他の学校外活動費,体験活動・地域活動,3506.0
182,公立,幼稚園,3,5,学習費総額,学校外活動費,その他の学校外活動費,芸術文化活動,17115.0
188,公立,幼稚園,3,5,学習費総額,学校外活動費,その他の学校外活動費,スポーツ・レクリエーション活動,34947.0
194,公立,幼稚園,3,5,学習費総額,学校外活動費,その他の学校外活動費,国際交流体験活動,1597.0
200,公立,幼稚園,3,5,学習費総額,学校外活動費,その他の学校外活動費,教養・その他,24258.0
228,公立,小学校,1,6,学習費総額,学校教育費,学校教育費,入学金・入園料,2140.0
240,公立,小学校,1,6,学習費総額,学校教育費,学校教育費,入学時に納付した施設整備費等,4175.0
252,公立,小学校,1,6,学習費総額,学校教育費,学校教育費,入学検定料,253.0
264,公立,小学校,1,6,学習費総額,学校教育費,学校教育費,授業料,0.0
276,公立,小学校,1,6,学習費総額,学校教育費,学校教育費,施設整備費等,0.0
288,公立,小学校,1,6,学習費総額,学校教育費,学校教育費,修学旅行費,0.0
300,公立,小学校,1,6,学習費総額,学校教育費,学校教育費,校外学習費,1408.0
312,公立,小学校,1,6,学習費総額,学校教育費,学校教育費,学級・児童会・生徒会費,2560.0
324,公立,小学校,1,6,学習費総額,学校教育費,学校教育費,その他の学校納付金,2827.0
336,公立,小学校,1,6,学習費総額,学校教育費,学校教育費,PTA会費,2745.0
348,公立,小学校,1,6,学習費総額,学校教育費,学校教育費,後援会費,85.0
360,公立,小学校,1,6,学習費総額,学校教育費,学校教育費,寄附金,62.0
372,公立,小学校,1,6,学習費総額,学校教育費,学校教育費,教科書費・教科書以外の図書費,5672.0
384,公立,小学校,1,6,学習費総額,学校教育費,学校教育費,学用品・実験実習材料費,46073.0
396,公立,小学校,1,6,学習費総額,学校教育費,学校教育費,教科外活動費,2109.0
408,公立,小学校,1,6,学習費総額,学校教育費,学校教育費,通学費,1923.0
420,公立,小学校,1,6,学習費総額,学校教育費,学校教育費,制服,2555.0
432,公立,小学校,1,6,学習費総額,学校教育費,学校教育費,通学用品費,73472.0
444,公立,小学校,1,6,学習費総額,学校教育費,学校教育費,その他学校教育費,11894.0
456,公立,小学校,1,6,学習費総額,学校給食費,学校給食費,学校給食費,39313.0
492,公立,小学校,1,6,学習費総額,学校外活動費,補助学習費,家庭内学習費,31072.0
504,公立,小学校,1,6,学習費総額,学校外活動費,補助学習費,通信教育・家庭教師費,20302.0
516,公立,小学校,1,6,学習費総額,学校外活動費,補助学習費,学習塾費,24839.0
528,公立,小学校,1,6,学習費総額,学校外活動費,補助学習費,その他補助学習費,760.0
552,公立,小学校,1,6,学習費総額,学校外活動費,その他の学校外活動費,体験活動・地域活動,7567.0
564,公立,小学校,1,6,学習費総額,学校外活動費,その他の学校外活動費,芸術文化活動,35850.0
576,公立,小学校,1,6,学習費総額,学校外活動費,その他の学校外活動費,スポーツ・レクリエーション活動,45644.0
588,公立,小学校,1,6,学習費総額,学校外活動費,その他の学校外活動費,国際交流体験活動,404.0
600,公立,小学校,1,6,学習費総額,学校外活動費,その他の学校外活動費,教養・その他,32564.0
229,公立,小学校,2,7,学習費総額,学校教育費,学校教育費,入学金・入園料,0.0
241,公立,小学校,2,7,学習費総額,学校教育費,学校教育費,入学時に納付した施設整備費等,0.0
253,公立,小学校,2,7,学習費総額,学校教育費,学校教育費,入学検定料,0.0
265,公立,小学校,2,7,学習費総額,学校教育費,学校教育費,授業料,0.0
277,公立,小学校,2,7,学習費総額,学校教育費,学校教育費,施設整備費等,0.0
289,公立,小学校,2,7,学習費総額,学校教育費,学校教育費,修学旅行費,0.0
301,公立,小学校,2,7,学習費総額,学校教育費,学校教育費,校外学習費,872.0
313,公立,小学校,2,7,学習費総額,学校教育費,学校教育費,学級・児童会・生徒会費,2171.0
325,公立,小学校,2,7,学習費総額,学校教育費,学校教育費,その他の学校納付金,1870.0
337,公立,小学校,2,7,学習費総額,学校教育費,学校教育費,PTA会費,2303.0
349,公立,小学校,2,7,学習費総額,学校教育費,学校教育費,後援会費,48.0
361,公立,小学校,2,7,学習費総額,学校教育費,学校教育費,寄附金,1730.0
373,公立,小学校,2,7,学習費総額,学校教育費,学校教育費,教科書費・教科書以外の図書費,7038.0
385,公立,小学校,2,7,学習費総額,学校教育費,学校教育費,学用品・実験実習材料費,20113.0
397,公立,小学校,2,7,学習費総額,学校教育費,学校教育費,教科外活動費,1032.0
409,公立,小学校,2,7,学習費総額,学校教育費,学校教育費,通学費,1330.0
421,公立,小学校,2,7,学習費総額,学校教育費,学校教育費,制服,425.0
433,公立,小学校,2,7,学習費総額,学校教育費,学校教育費,通学用品費,10380.0
445,公立,小学校,2,7,学習費総額,学校教育費,学校教育費,その他学校教育費,4095.0
457,公立,小学校,2,7,学習費総額,学校給食費,学校給食費,学校給食費,40508.0
493,公立,小学校,2,7,学習費総額,学校外活動費,補助学習費,家庭内学習費,9901.0
505,公立,小学校,2,7,学習費総額,学校外活動費,補助学習費,通信教育・家庭教師費,18671.0
517,公立,小学校,2,7,学習費総額,学校外活動費,補助学習費,学習塾費,27898.0
529,公立,小学校,2,7,学習費総額,学校外活動費,補助学習費,その他補助学習費,1384.0
553,公立,小学校,2,7,学習費総額,学校外活動費,その他の学校外活動費,体験活動・地域活動,11309.0
565,公立,小学校,2,7,学習費総額,学校外活動費,その他の学校外活動費,芸術文化活動,28663.0
577,公立,小学校,2,7,学習費総額,学校外活動費,その他の学校外活動費,スポーツ・レクリエーション活動,50394.0
589,公立,小学校,2,7,学習費総額,学校外活動費,その他の学校外活動費,国際交流体験活動,256.0
601,公立,小学校,2,7,学習費総額,学校外活動費,その他の学校外活動費,教養・その他,25746.0
230,公立,小学校,3,8,学習費総額,学校教育費,学校教育費,入学金・入園料,0.0
242,公立,小学校,3,8,学習費総額,学校教育費,学校教育費,入学時に納付した施設整備費等,0.0
254,公立,小学校,3,8,学習費総額,学校教育費,学校教育費,入学検定料,0.0
266,公立,小学校,3,8,学習費総額,学校教育費,学校教育費,授業料,0.0
278,公立,小学校,3,8,学習費総額,学校教育費,学校教育費,施設整備費等,0.0
290,公立,小学校,3,8,学習費総額,学校教育費,学校教育費,修学旅行費,0.0
302,公立,小学校,3,8,学習費総額,学校教育費,学校教育費,校外学習費,1905.0
314,公立,小学校,3,8,学習費総額,学校教育費,学校教育費,学級・児童会・生徒会費,1714.0
326,公立,小学校,3,8,学習費総額,学校教育費,学校教育費,その他の学校納付金,3741.0
338,公立,小学校,3,8,学習費総額,学校教育費,学校教育費,PTA会費,2029.0
350,公立,小学校,3,8,学習費総額,学校教育費,学校教育費,後援会費,15.0
362,公立,小学校,3,8,学習費総額,学校教育費,学校教育費,寄附金,225.0
374,公立,小学校,3,8,学習費総額,学校教育費,学校教育費,教科書費・教科書以外の図書費,5047.0
386,公立,小学校,3,8,学習費総額,学校教育費,学校教育費,学用品・実験実習材料費,24208.0
398,公立,小学校,3,8,学習費総額,学校教育費,学校教育費,教科外活動費,1033.0
410,公立,小学校,3,8,学習費総額,学校教育費,学校教育費,通学費,504.0
422,公立,小学校,3,8,学習費総額,学校教育費,学校教育費,制服,533.0
434,公立,小学校,3,8,学習費総額,学校教育費,学校教育費,通学用品費,7714.0
446,公立,小学校,3,8,学習費総額,学校教育費,学校教育費,その他学校教育費,4457.0
458,公立,小学校,3,8,学習費総額,学校給食費,学校給食費,学校給食費,39184.0
494,公立,小学校,3,8,学習費総額,学校外活動費,補助学習費,家庭内学習費,11078.0
506,公立,小学校,3,8,学習費総額,学校外活動費,補助学習費,通信教育・家庭教師費,26902.0
518,公立,小学校,3,8,学習費総額,学校外活動費,補助学習費,学習塾費,40776.0
530,公立,小学校,3,8,学習費総額,学校外活動費,補助学習費,その他補助学習費,897.0
554,公立,小学校,3,8,学習費総額,学校外活動費,その他の学校外活動費,体験活動・地域活動,3645.0
566,公立,小学校,3,8,学習費総額,学校外活動費,その他の学校外活動費,芸術文化活動,29410.0
578,公立,小学校,3,8,学習費総額,学校外活動費,その他の学校外活動費,スポーツ・レクリエーション活動,64966.0
590,公立,小学校,3,8,学習費総額,学校外活動費,その他の学校外活動費,国際交流体験活動,107.0
602,公立,小学校,3,8,学習費総額,学校外活動費,その他の学校外活動費,教養・その他,25371.0
231,公立,小学校,4,9,学習費総額,学校教育費,学校教育費,入学金・入園料,0.0
243,公立,小学校,4,9,学習費総額,学校教育費,学校教育費,入学時に納付した施設整備費等,0.0
255,公立,小学校,4,9,学習費総額,学校教育費,学校教育費,入学検定料,0.0
267,公立,小学校,4,9,学習費総額,学校教育費,学校教育費,授業料,0.0
279,公立,小学校,4,9,学習費総額,学校教育費,学校教育費,施設整備費等,0.0
291,公立,小学校,4,9,学習費総額,学校教育費,学校教育費,修学旅行費,0.0
303,公立,小学校,4,9,学習費総額,学校教育費,学校教育費,校外学習費,1759.0
315,公立,小学校,4,9,学習費総額,学校教育費,学校教育費,学級・児童会・生徒会費,2468.0
327,公立,小学校,4,9,学習費総額,学校教育費,学校教育費,その他の学校納付金,2678.0
339,公立,小学校,4,9,学習費総額,学校教育費,学校教育費,PTA会費,3697.0
351,公立,小学校,4,9,学習費総額,学校教育費,学校教育費,後援会費,39.0
363,公立,小学校,4,9,学習費総額,学校教育費,学校教育費,寄附金,248.0
375,公立,小学校,4,9,学習費総額,学校教育費,学校教育費,教科書費・教科書以外の図書費,4975.0
387,公立,小学校,4,9,学習費総額,学校教育費,学校教育費,学用品・実験実習材料費,24274.0
399,公立,小学校,4,9,学習費総額,学校教育費,学校教育費,教科外活動費,3618.0
411,公立,小学校,4,9,学習費総額,学校教育費,学校教育費,通学費,1012.0
423,公立,小学校,4,9,学習費総額,学校教育費,学校教育費,制服,905.0
435,公立,小学校,4,9,学習費総額,学校教育費,学校教育費,通学用品費,9740.0
447,公立,小学校,4,9,学習費総額,学校教育費,学校教育費,その他学校教育費,5098.0
459,公立,小学校,4,9,学習費総額,学校給食費,学校給食費,学校給食費,35662.0
495,公立,小学校,4,9,学習費総額,学校外活動費,補助学習費,家庭内学習費,9709.0
507,公立,小学校,4,9,学習費総額,学校外活動費,補助学習費,通信教育・家庭教師費,15700.0
519,公立,小学校,4,9,学習費総額,学校外活動費,補助学習費,学習塾費,53250.0
531,公立,小学校,4,9,学習費総額,学校外活動費,補助学習費,その他補助学習費,1696.0
555,公立,小学校,4,9,学習費総額,学校外活動費,その他の学校外活動費,体験活動・地域活動,4507.0
567,公立,小学校,4,9,学習費総額,学校外活動費,その他の学校外活動費,芸術文化活動,23841.0
579,公立,小学校,4,9,学習費総額,学校外活動費,その他の学校外活動費,スポーツ・レクリエーション活動,67195.0
591,公立,小学校,4,9,学習費総額,学校外活動費,その他の学校外活動費,国際交流体験活動,952.0
603,公立,小学校,4,9,学習費総額,学校外活動費,その他の学校外活動費,教養・その他,32380.0
232,公立,小学校,5,10,学習費総額,学校教育費,学校教育費,入学金・入園料,0.0
244,公立,小学校,5,10,学習費総額,学校教育費,学校教育費,入学時に納付した施設整備費等,0.0
256,公立,小学校,5,10,学習費総額,学校教育費,学校教育費,入学検定料,0.0
268,公立,小学校,5,10,学習費総額,学校教育費,学校教育費,授業料,0.0
280,公立,小学校,5,10,学習費総額,学校教育費,学校教育費,施設整備費等,0.0
292,公立,小学校,5,10,学習費総額,学校教育費,学校教育費,修学旅行費,31.0
304,公立,小学校,5,10,学習費総額,学校教育費,学校教育費,校外学習費,5996.0
316,公立,小学校,5,10,学習費総額,学校教育費,学校教育費,学級・児童会・生徒会費,3311.0
328,公立,小学校,5,10,学習費総額,学校教育費,学校教育費,その他の学校納付金,4012.0
340,公立,小学校,5,10,学習費総額,学校教育費,学校教育費,PTA会費,2701.0
352,公立,小学校,5,10,学習費総額,学校教育費,学校教育費,後援会費,19.0
364,公立,小学校,5,10,学習費総額,学校教育費,学校教育費,寄附金,305.0
376,公立,小学校,5,10,学習費総額,学校教育費,学校教育費,教科書費・教科書以外の図書費,6594.0
388,公立,小学校,5,10,学習費総額,学校教育費,学校教育費,学用品・実験実習材料費,26829.0
400,公立,小学校,5,10,学習費総額,学校教育費,学校教育費,教科外活動費,5434.0
412,公立,小学校,5,10,学習費総額,学校教育費,学校教育費,通学費,763.0
424,公立,小学校,5,10,学習費総額,学校教育費,学校教育費,制服,448.0
436,公立,小学校,5,10,学習費総額,学校教育費,学校教育費,通学用品費,9363.0
448,公立,小学校,5,10,学習費総額,学校教育費,学校教育費,その他学校教育費,6506.0
460,公立,小学校,5,10,学習費総額,学校給食費,学校給食費,学校給食費,39105.0
496,公立,小学校,5,10,学習費総額,学校外活動費,補助学習費,家庭内学習費,12984.0
508,公立,小学校,5,10,学習費総額,学校外活動費,補助学習費,通信教育・家庭教師費,24475.0
520,公立,小学校,5,10,学習費総額,学校外活動費,補助学習費,学習塾費,79469.0
532,公立,小学校,5,10,学習費総額,学校外活動費,補助学習費,その他補助学習費,1519.0
556,公立,小学校,5,10,学習費総額,学校外活動費,その他の学校外活動費,体験活動・地域活動,5472.0
568,公立,小学校,5,10,学習費総額,学校外活動費,その他の学校外活動費,芸術文化活動,25072.0
580,公立,小学校,5,10,学習費総額,学校外活動費,その他の学校外活動費,スポーツ・レクリエーション活動,54732.0
592,公立,小学校,5,10,学習費総額,学校外活動費,その他の学校外活動費,国際交流体験活動,809.0
604,公立,小学校,5,10,学習費総額,学校外活動費,その他の学校外活動費,教養・その他,38488.0
233,公立,小学校,6,11,学習費総額,学校教育費,学校教育費,入学金・入園料,0.0
245,公立,小学校,6,11,学習費総額,学校教育費,学校教育費,入学時に納付した施設整備費等,0.0
257,公立,小学校,6,11,学習費総額,学校教育費,学校教育費,入学検定料,0.0
269,公立,小学校,6,11,学習費総額,学校教育費,学校教育費,授業料,0.0
281,公立,小学校,6,11,学習費総額,学校教育費,学校教育費,施設整備費等,0.0
293,公立,小学校,6,11,学習費総額,学校教育費,学校教育費,修学旅行費,21986.0
305,公立,小学校,6,11,学習費総額,学校教育費,学校教育費,校外学習費,1960.0
317,公立,小学校,6,11,学習費総額,学校教育費,学校教育費,学級・児童会・生徒会費,2787.0
329,公立,小学校,6,11,学習費総額,学校教育費,学校教育費,その他の学校納付金,2478.0
341,公立,小学校,6,11,学習費総額,学校教育費,学校教育費,PTA会費,2677.0
353,公立,小学校,6,11,学習費総額,学校教育費,学校教育費,後援会費,46.0
365,公立,小学校,6,11,学習費総額,学校教育費,学校教育費,寄附金,30.0
377,公立,小学校,6,11,学習費総額,学校教育費,学校教育費,教科書費・教科書以外の図書費,5841.0
389,公立,小学校,6,11,学習費総額,学校教育費,学校教育費,学用品・実験実習材料費,19339.0
401,公立,小学校,6,11,学習費総額,学校教育費,学校教育費,教科外活動費,5430.0
413,公立,小学校,6,11,学習費総額,学校教育費,学校教育費,通学費,3484.0
425,公立,小学校,6,11,学習費総額,学校教育費,学校教育費,制服,7007.0
437,公立,小学校,6,11,学習費総額,学校教育費,学校教育費,通学用品費,9732.0
449,公立,小学校,6,11,学習費総額,学校教育費,学校教育費,その他学校教育費,11513.0
461,公立,小学校,6,11,学習費総額,学校給食費,学校給食費,学校給食費,36789.0
497,公立,小学校,6,11,学習費総額,学校外活動費,補助学習費,家庭内学習費,10779.0
509,公立,小学校,6,11,学習費総額,学校外活動費,補助学習費,通信教育・家庭教師費,19897.0
521,公立,小学校,6,11,学習費総額,学校外活動費,補助学習費,学習塾費,106785.0
533,公立,小学校,6,11,学習費総額,学校外活動費,補助学習費,その他補助学習費,3417.0
557,公立,小学校,6,11,学習費総額,学校外活動費,その他の学校外活動費,体験活動・地域活動,3803.0
569,公立,小学校,6,11,学習費総額,学校外活動費,その他の学校外活動費,芸術文化活動,32801.0
581,公立,小学校,6,11,学習費総額,学校外活動費,その他の学校外活動費,スポーツ・レクリエーション活動,53139.0
593,公立,小学校,6,11,学習費総額,学校外活動費,その他の学校外活動費,国際交流体験活動,1858.0
605,公立,小学校,6,11,学習費総額,学校外活動費,その他の学校外活動費,教養・その他,32094.0
    """
    df_merged = df.merge(
        mapping[["level1", "level2", "level3", "level4"]],
        left_on="学習費区分",
        right_on="level4",
        how="left"
    )
    
    # Remove rows where all level columns are null
    df_merged = df_merged.dropna(
        subset=['level1', 'level2', 'level3', 'level4'], 
        how='all'
    )
    
    # Remove original category column
    df_merged = df_merged.drop(columns=['学習費区分'])
    
    # Rename level columns
    df_merged = df_merged.rename(columns={
        'level1': '学習費区分1',
        'level2': '学習費区分2',
        'level3': '学習費区分3',
        'level4': '学習費区分4',
    })
    
    print("Data merged with mapping successfully")
    return df_merged

df_merged = merge_with_mapping(df_processed, processed_mapping).fillna(0)
df_final = df_merged[['公立・私立区分', '学校', '学年', '年齢', '学習費区分1', '学習費区分2', '学習費区分3', '学習費区分4', '学習費']].sort_values(['公立・私立区分', '年齢'])

# 学習費区分1～4 を行の MultiIndex、指定の列をカラムに、学習費を値にするピボット
df_table = df_merged.pivot(
    index=['公立・私立区分', '学校', '学年', '年齢'],
    columns=['学習費区分1', '学習費区分2', '学習費区分3', '学習費区分4'],
    values='学習費'
)

# 必要に応じて、列の並び替えやソートを行うこともできます
df_table = df_table.sort_index(level=[0, 3], axis=0).sort_index(axis=1)

# 確認
print(str(df_table.to_csv()))
"""
学習費区分1,,,,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額,学習費総額
学習費区分2,,,,学校外活動費,学校外活動費,学校外活動費,学校外活動費,学校外活動費,学校外活動費,学校外活動費,学校外活動費,学校外活動費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校給食費
学習費区分3,,,,その他の学校外活動費,その他の学校外活動費,その他の学校外活動費,その他の学校外活動費,その他の学校外活動費,補助学習費,補助学習費,補助学習費,補助学習費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校教育費,学校給食費
学習費区分4,,,,スポーツ・レクリエーション活動,体験活動・地域活動,国際交流体験活動,教養・その他,芸術文化活動,その他補助学習費,学習塾費,家庭内学習費,通信教育・家庭教師費,PTA会費,その他の学校納付金,その他学校教育費,修学旅行費,入学時に納付した施設整備費等,入学検定料,入学金・入園料,制服,学用品・実験実習材料費,学級・児童会・生徒会費,寄附金,後援会費,授業料,教科外活動費,教科書費・教科書以外の図書費,施設整備費等,校外学習費,通学用品費,通学費,学校給食費
公立・私立区分,学校,学年,年齢,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
公立,幼稚園,1,3,11960.0,2566.0,47.0,17804.0,4331.0,347.0,6109.0,5897.0,6568.0,4189.0,1715.0,16076.0,0.0,727.0,97.0,1025.0,6225.0,12588.0,1798.0,146.0,127.0,4223.0,614.0,3134.0,0.0,1040.0,11430.0,13857.0,14951.0
公立,幼稚園,2,4,25161.0,5080.0,885.0,22029.0,12801.0,820.0,14313.0,6948.0,9805.0,4004.0,1620.0,10624.0,0.0,59.0,13.0,322.0,2539.0,8869.0,1728.0,81.0,63.0,5929.0,448.0,2899.0,0.0,1441.0,7275.0,6564.0,14649.0
公立,幼稚園,3,5,34947.0,3506.0,1597.0,24258.0,17115.0,862.0,18034.0,11879.0,11502.0,3839.0,1458.0,14392.0,0.0,0.0,0.0,0.0,2496.0,10213.0,1891.0,219.0,132.0,5610.0,1405.0,2873.0,0.0,1751.0,22918.0,6891.0,15829.0
公立,小学校,1,6,45644.0,7567.0,404.0,32564.0,35850.0,760.0,24839.0,31072.0,20302.0,2745.0,2827.0,11894.0,0.0,4175.0,253.0,2140.0,2555.0,46073.0,2560.0,62.0,85.0,0.0,2109.0,5672.0,0.0,1408.0,73472.0,1923.0,39313.0
公立,小学校,2,7,50394.0,11309.0,256.0,25746.0,28663.0,1384.0,27898.0,9901.0,18671.0,2303.0,1870.0,4095.0,0.0,0.0,0.0,0.0,425.0,20113.0,2171.0,1730.0,48.0,0.0,1032.0,7038.0,0.0,872.0,10380.0,1330.0,40508.0
公立,小学校,3,8,64966.0,3645.0,107.0,25371.0,29410.0,897.0,40776.0,11078.0,26902.0,2029.0,3741.0,4457.0,0.0,0.0,0.0,0.0,533.0,24208.0,1714.0,225.0,15.0,0.0,1033.0,5047.0,0.0,1905.0,7714.0,504.0,39184.0
公立,小学校,4,9,67195.0,4507.0,952.0,32380.0,23841.0,1696.0,53250.0,9709.0,15700.0,3697.0,2678.0,5098.0,0.0,0.0,0.0,0.0,905.0,24274.0,2468.0,248.0,39.0,0.0,3618.0,4975.0,0.0,1759.0,9740.0,1012.0,35662.0
公立,小学校,5,10,54732.0,5472.0,809.0,38488.0,25072.0,1519.0,79469.0,12984.0,24475.0,2701.0,4012.0,6506.0,31.0,0.0,0.0,0.0,448.0,26829.0,3311.0,305.0,19.0,0.0,5434.0,6594.0,0.0,5996.0,9363.0,763.0,39105.0
"""
